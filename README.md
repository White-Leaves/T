## 分布式秒杀商城gomall

### 简介

   使用go-zero微服务框架，etcd服务发现，使用dtm实现分布式，kafka消息队列，mysql数据库，redis缓存，Jwt token认证。秒杀部分使用batcher批量写入kafka，在redis中减库存。监控采用prometheus。
   参考looklook等项目制作。
   gomall主要实现用户登陆注册，商品详情和商品库存操作，订单创建，订单支付，秒杀等功能。

   项目目录结构：
    app：所有业务代码，包含rpc、api
    deploy：包含依赖的配置文件，sql生成表文件
    pkg：包含通用组件，如MD5加密，batcher等

### 用户服务

 用户服务实现用户注册，登录，查看用户详情的功能。
 用户使用手机号进行登录和注册。
 用户登录使用token进行验证，用户密码使用MD5加盐加密。

### 商品服务

商品服务实现商品详情查看，修改库存，修改库存回滚的功能。
商品库存修改使用dtm子事务屏障进行，如果库存不足则修改失败，失败后进行库存回滚。

### 订单服务

订单服务实现创建订单和产看订单详情功能，订单使用snowflake作为订单号sn。
创建订单使用dtm的saga事务实现分布式，子事务屏障保证分布式一致性。saga事务分为创建订单和减扣库存两个子事务。子事务失败会使订单创建回滚，将订单状态修改为已关闭。

### 秒杀

秒杀使用kafka实现，kafka的zookeeper保证只消费一次，使用Periodlimiter限制用户请求次数，使用batcher批量写入数据，batcher使用商品id来Shareing，保证数据串行，可以将pid不同的请求分开。

通过batcher将数据发送到一个channel，再由consumer进行处理，保证一个进程处理。

consumer先检查商品是否存在，库存是否小于0，再创建订单，最后更新数据库库存。检查商品商品时直接在缓存中检查库存，使用Lua脚本保证检查和减库存的原子性，通过缓存预减库存防止超卖。



### 支付服务

支付服务实现修改订单状态完成支付

支付时获取用户id和订单sn来找到订单，支付后修改订单状态为已支付。
